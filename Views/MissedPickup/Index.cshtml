@model IEnumerable<AspnetCoreMvcFull.Models.MissedPickup>

@{
	ViewData["Title"] = "Missed Pickups";
	Layout = "~/Views/Shared/_ContentNavbarLayout.cshtml";
}

<div class="container-xxl flex-grow-1 container-p-y">
	<div class="row">
		<div class="col-12">
			<div class="card">
				<div class="card-header d-flex justify-content-between align-items-center">
					<h5 class="mb-0">
						<i class="bx bx-error-circle me-2 text-danger"></i>
						Missed Pickups Management
					</h5>
					<div>
						<a asp-action="Detect" class="btn btn-warning">
							<i class="bx bx-search me-1"></i>
							Run Detection
						</a>
					</div>
				</div>

				@if (TempData["SuccessMessage"] != null)
				{
					<div class="alert alert-success alert-dismissible fade show m-3" role="alert">
						<i class="bx bx-check-circle me-2"></i>
						@TempData["SuccessMessage"]
						<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
					</div>
				}

				@if (TempData["InfoMessage"] != null)
				{
					<div class="alert alert-info alert-dismissible fade show m-3" role="alert">
						<i class="bx bx-info-circle me-2"></i>
						@TempData["InfoMessage"]
						<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
					</div>
				}

				@if (TempData["ErrorMessage"] != null)
				{
					<div class="alert alert-danger alert-dismissible fade show m-3" role="alert">
						<i class="bx bx-error me-2"></i>
						@TempData["ErrorMessage"]
						<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
					</div>
				}

				<div class="card-body">
					@if (Model.Any())
					{
						<div class="table-responsive">
							<table class="table table-hover">
								<thead class="table-light">
									<tr>
										<th>Schedule</th>
										<th>Route</th>
										<th>Collector</th>
										<th>Detected At</th>
										<th>Status</th>
										<th>System Reason</th>
										<th>Actions</th>
									</tr>
								</thead>
								<tbody>
									@foreach (var item in Model)
									{
										<tr>
											<td>
												<strong>#@item.Schedule?.Id</strong>
												<br>
												<small class="text-muted">
													@item.Schedule?.ScheduleStartTime.ToString("MMM dd, yyyy")
												</small>
											</td>
											<td>
												@item.Schedule?.Route?.Name
												<br>
												<small class="text-muted">
													@item.Schedule?.CollectionPoints?.Count() points
												</small>
											</td>
											<td>
												@if (item.Schedule?.Collector != null)
												{
													<span>@item.Schedule.Collector.FirstName @item.Schedule.Collector.LastName</span>
													<br>
													<small class="text-muted">@item.Schedule.Collector.Email</small>
												}
												else
												{
													<span class="text-muted">Unknown Collector</span>
												}
											</td>
											<td>
												@item.DetectedAt.ToString("MMM dd, yyyy")
												<br>
												<small class="text-muted">@item.DetectedAt.ToString("HH:mm")</small>
											</td>
											<td>
												@if (item.Status == "Pending")
												{
													<span class="badge bg-warning">
														<i class="bx bx-time me-1"></i>Pending
													</span>
												}
												else if (item.Status == "Resolved")
												{
													<span class="badge bg-success">
														<i class="bx bx-check me-1"></i>Resolved
													</span>
												}
												else
												{
													<span class="badge bg-secondary">@item.Status</span>
												}
											</td>
											<td>
												@if (!string.IsNullOrEmpty(item.Reason))
												{
													<span title="@item.Reason">
														@(item.Reason.Length > 50 ? item.Reason.Substring(0, 50) + "..." : item.Reason)
													</span>
												}
												else
												{
													<span class="text-muted">Auto-detected</span>
												}
											</td>
											<td>
												<div class="btn-group" role="group">
													<a asp-action="Details" asp-route-id="@item.Id"
													   class="btn btn-sm btn-outline-info" title="View Details">
														<i class="bx bx-show"></i>
													</a>
													@if (item.Status == "Pending")
													{
														<a asp-action="Resolve" asp-route-id="@item.Id"
														   class="btn btn-sm btn-primary" title="Resolve">
															<i class="bx bx-check"></i>
														</a>
													}
												</div>
											</td>
										</tr>
									}
								</tbody>
							</table>
						</div>
					}
					else
					{
						<div class="text-center py-5">
							<i class="bx bx-check-circle display-1 text-success"></i>
							<h4 class="mt-3">No Missed Pickups Found</h4>
							<p class="text-muted">All scheduled pickups are on track. Run detection to check for new missed pickups.</p>
						</div>
					}
				</div>
			</div>
		</div>
	</div>
</div>
